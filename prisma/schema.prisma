generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["orderByAggregateGroup", "selectRelationCount"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dao {
  id          Int    @id @default(autoincrement()) @map("id")
  name        String @map("name")
  tokenSymbol String @map("token_symbol")

  //relations
  protocols   Protocol[]   @relation("ProtocolToDao")
  members     Member[]     @relation("MemberToDao")
  proposals   Proposal[]   @relation("DaoToProposal")
  allocations Allocation[] @relation("AllocationToDao")
  delegations Delegation[] @relation("DelegationToDao")

  @@map("dao")
}

model Protocol {
  id                  Int      @id @default(autoincrement()) @map("id")
  epoch               Int      @map("epoch")
  dntWithdrawFee      Int      @map("dnt_withdraw_fee")
  usdcWithdrawFee     Int      @map("usdc_withdraw_fee")
  mintAmt             Int?     @map("mint_amt")
  budgetAmt           Int?     @map("budget_amt")
  rewardDistributions Json?    @map("reward_distributions")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  daoId Int @map("dao_id")

  // relations
  dao         Dao          @relation("ProtocolToDao", fields: [daoId], references: [id])
  members     Member[]     @relation("ProtocolToMember")
  dntTokens   DntToken[]   @relation("ProtocolToDnt")
  usdcTokens  UsdcToken[]  @relation("ProtocolToUsdc")
  allocations Allocation[] @relation("ProtocolToAllocation")
  delegations Delegation[] @relation("ProtocolToDelegation")
  proposals   Proposal[]   @relation("ProtocolToProposal")

  // contraints
  @@unique([epoch, daoId])

  // indexes
  @@index([epoch])
  @@index([daoId])

  // dntRewardDistributions will be populated at the end of the epoch
  // and will contain the results of the epoch allocations.
  @@map("protocol")
}

model Member {
  id                    Int        @id @default(autoincrement()) @map("id")
  ethAddress            String     @db.VarChar(42) @map("eth_address")
  type                  MemberType @map("type")
  alias                 String?    @db.VarChar(42) @map("alias")
  liquidityCapUsdc      Int?       @map("liquidity_cap_usdc")
  liquidityCapEpochUsdc Int?       @map("liquidity_cap_epoch_usdc")

  // previous ApiMember fields
  totalLiquidity     Decimal? @map("total_liquidity") @db.Decimal(20, 8)
  totalRewardsEarned Decimal? @map("total_rewards_earned") @db.Decimal(20, 8)
  netGain            Decimal? @map("net_gain") @db.Decimal(20, 8)
  netPosition        Decimal? @map("net_position") @db.Decimal(20, 8)
  claimed            Boolean  @default(false) @map("claimed")
  cap                Int?     @map("cap")
  nonce              String   @default(uuid()) @map("nonce")

  // utility fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  daoId      Int @map("dao_id")
  protocolId Int @map("protocol_id")

  // relations
  dao             Dao            @relation("MemberToDao", fields: [daoId], references: [id])
  protocol        Protocol       @relation("ProtocolToMember", fields: [protocolId], references: [id])
  dntTokens       DntToken[]     @relation("MemberToDnt")
  usdcTokens      UsdcToken[]    @relation("MemberToUsdc")
  fromAllocations Allocation[]   @relation("MemberToAllocation_fromMember") // maybe sentValue... receivedValue... would be better than toValue... fromValue...
  toAllocations   Allocation[]   @relation("MemberToAllocation_toMember")
  fromDelegations Delegation[]   @relation("MemberToDelegation_fromMember")
  toDelegations   Delegation[]   @relation("MemberToDelegation_toMember")
  proposals       Proposal[]     @relation("MemberToProposal")
  votes           ProposalVote[] @relation("MemberToVote")


  // contraints
  @@unique([daoId, ethAddress])
  @@unique([daoId, alias])

  // index
  @@index([ethAddress], name: "ethAddress")
  @@index([daoId], name: "member_dao_id")
  @@index([protocolId], name: "member_protocol_id")

  @@map("member")
}

model Delegation {
  id        Int      @id @default(autoincrement()) @map("id")
  weight    Int      @map("weight")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  daoId        Int @map("dao_id")
  protocolId   Int @map("protocol_id")
  fromMemberId Int @map("from_member_id")
  toMemberId   Int @map("to_member_id")

  // relations
  dao        Dao      @relation("DelegationToDao", fields: [daoId], references: [id])
  protocol   Protocol @relation("ProtocolToDelegation", fields: [protocolId], references: [id])
  fromMember Member   @relation("MemberToDelegation_fromMember", fields: [fromMemberId], references: [id])
  toMember   Member   @relation("MemberToDelegation_toMember", fields: [fromMemberId], references: [id])

  // contraints
  @@unique([protocolId, fromMemberId, toMemberId])

  // indexes
  @@index([protocolId])
  @@index([fromMemberId])
  @@index([toMemberId])

  @@map("delegation")
}

model Allocation {
  id        Int      @id @default(autoincrement()) @map("id")
  weight    Int      @map("weight")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  daoId        Int @map("dao_id")
  protocolId   Int @map("protocol_id")
  fromMemberId Int @map("from_member_id")
  toMemberId   Int @map("to_member_id")

  //relations
  dao        Dao      @relation("AllocationToDao", fields: [daoId], references: [id])
  protocol   Protocol @relation("ProtocolToAllocation", fields: [protocolId], references: [id])
  fromMember Member   @relation("MemberToAllocation_fromMember", fields: [fromMemberId], references: [id])
  toMember   Member   @relation("MemberToAllocation_toMember", fields: [toMemberId], references: [id])

  //contraints
  @@unique([fromMemberId, toMemberId, protocolId], name: "Allocation_fromMemberId_toMemberId_protocolId_key")

  // indexes
  @@index([fromMemberId], name: "allocation_from_member_id")
  @@index([toMemberId], name: "allocation_to_member_id")
  @@index([protocolId], name: "protocol_id")

  @@map("allocation")
}

// TOKENS
model DntToken {
  id              Int                @id @default(autoincrement()) @map("id")
  transactionType DntTransactionType @map("transaction_type")
  amount          Decimal            @map("amount") @db.Decimal(20, 8)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // scalar relation fields
  protocolId Int @map("protocol_id")
  memberId   Int @map("member_id")

  // relations
  protocol Protocol @relation("ProtocolToDnt", fields: [protocolId], references: [id])
  member   Member   @relation("MemberToDnt", fields: [memberId], references: [id])

  // indexes
  @@index([protocolId], name: "dnt_token_protocol_id")
  @@index([memberId], name: "dnt_token_member")

  @@map("dnt_token")
}

model UsdcToken {
  id              Int                 @id @default(autoincrement()) @map("id")
  transactionType UsdcTransactionType @map("transaction_type")
  amount          Decimal             @map("amount") @db.Decimal(20, 8)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // scalar relation fields
  protocolId Int @map("protocol_id")
  memberId   Int @map("member_id")

  // relations
  protocol Protocol @relation("ProtocolToUsdc", fields: [protocolId], references: [id])
  member   Member   @relation("MemberToUsdc", fields: [memberId], references: [id])

  // indexes
  @@index([protocolId], name: "usdc_token_protocol_id")
  @@index([memberId], name: "usdc_token_member_id")

  @@map("usdc_token")
}

// GOVERNANCE
model Proposal {
  // result field JSON object structure:
  // {
  //  netVotes: 500,
  //  netVotesNeeded: 0,
  //  totalAvailableVotes: 1000,
  //  inFavorOfVotes: 750,
  //  againstVotes: 250,
  //  votes: [{
  //    id: 1,
  //    ethAddress: "asdfasdfdasdf",
  //    alias: "zaz",
  //    inFavorOf: true,
  //    voteCount: 1000
  //  }]
  // }
  id         Int      @id @default(autoincrement()) @map("id")
  category   String   @map("category")
  name       String   @map("name")
  desc       String   @map("desc")
  duration   Int      @map("duration") @default(1) // the amount of epochs this vote is active for
  isApproved Boolean  @map("is_approved") @default(false)
  isActive   Boolean  @map("is_active") @default(false)
  result     Json?    @map("result")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  daoId      Int @map("dao_id")
  proposerId Int @map("proposer_id")
  protocolId Int @map("protocol_id")

  //relations
  dao      Dao            @relation("DaoToProposal", fields: [daoId], references: [id])
  proposer Member         @relation("MemberToProposal", fields: [proposerId], references: [id])
  protocol Protocol       @relation("ProtocolToProposal", fields: [protocolId], references: [id])
  votes    ProposalVote[] @relation("ProposalToVote")

  //indexes
  @@index([id])
  @@index([protocolId])

  @@map("proposal")
}

model ProposalVote {
  id        Int      @id @default(autoincrement()) @map("id")
  inFavorOf Boolean  @map("in_favor_of")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // scalar relation fields
  proposalId Int @map("proposal_id")
  voterId    Int @map("voter_id")

  //relations
  proposal Proposal @relation("ProposalToVote", fields: [proposalId], references: [id])
  voter    Member   @relation("MemberToVote", fields: [voterId], references: [id])

  // constraints
  @@unique([proposalId, voterId])

  //indexes
  @@index([proposalId])
  @@index([voterId])

  @@map("proposal_vote")
}

// enums
enum MemberType {
  ENTITY
  PERSONAL
}

enum DntTransactionType {
  CONTRIBUTOR_REWARD
  LP_REWARD
  SWAP
  STAKE
}

enum UsdcTransactionType {
  DEPOSIT
  WITHDRAW
  SWAP
}
